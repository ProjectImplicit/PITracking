<html>
<head>
	<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="css/custom-theme/jquery-ui-1.10.0.custom.css" rel="stylesheet">
<link rel="stylesheet" href="js/tablesorter/themes/blue/style.css" type="text/css" id="" media="print, projection, screen" />
<link type="text/css" rel="stylesheet" href="css/jquery.dropdown.css" />
<link href="//netdna.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet">
<script src="//code.jquery.com/jquery-1.10.2.min.js"></script>
<script src="js/jquery-ui-1.10.3.custom.min.js"></script>
<script src="js/jquery.csvToTable.js"></script>
<script type="text/javascript" src="js/tablesorter/jquery.tablesorter.js"></script> 
<script type="text/javascript" src="js/jquery.dropdown.js"></script>
<title>PI stats</title>

<style>
.inline{
	display: inline-block;
}
input[type=text]{
	width:120px;
}
.container{
	margin-top:50px;
	margin-left:8%;
	margin-right:8%;
	
	
	
}

.ui-icon{
	display:inline-block;
	margin-left:2px;
}
#instruct1{
	
	font-family: "Times New Roman";
	width:65%;
	margin-bottom: 35px;
	display:none;

}
#instruct2{
	
	margin-top:15px;
	margin-bottom:20px;
}
#collapse{
	width:107px;
	height:22px;
	margin-left:0.6%;
	line-height:auto;
	padding: 2px 10px 15px 10px;
	border-radius: 7px;
	/*margin-left:36%;*/
}
.ui-tooltip {
  background: white;
  color: blue;
  max-height: 0.8px;
  font-size: 12px;
 padding:10px;
  
}

.tooltip{
	padding:10px;
	margin-bottom: 10px;
}
#download{
	width:120px;
	height:22px;
	line-height:auto;
	padding: 2px 10px 15px 10px;
}
</style>
<script>
/////////Globals///////////
var csv;
var csvName;
var submit;
var resultCVS;
var dbChoise;
var currentChoise;
var lastTaskVal ='';
var lastStudyVal ='';
var test = 'newwarehouse';
var ctrlMode = false; 
var method='3';
var refresh ='no';
var threads='yes';

//var curl='http://dw2.psyc.virginia.edu/implicit/research/library/randomStudiesConfig/RandomStudiesConfig.xml';
//var hurl='http://dw2.psyc.virginia.edu/implicit/research/library/randomStudiesConfig/HistoryRand.xml';
//var cpath='research/library/randomStudiesConfig/RandomStudiesConfig.xml';
//var hpath='research/library/randomStudiesConfig/HistoryRand.xml';
//var baseURL='http://dw2.psyc.virginia.edu/implicit';
var curl='http://app-dev-01.implicit.harvard.edu/implicit/research/library/randomStudiesConfig/RandomStudiesConfig.xml';
var hurl='http://app-dev-01.implicit.harvard.edu/implicit/research/library/randomStudiesConfig/HistoryRand.xml';
var cpath='research/library/randomStudiesConfig/RandomStudiesConfig.xml';
var hpath='research/library/randomStudiesConfig/HistoryRand.xml';
var baseURL='http://app-dev-01.implicit.harvard.edu/implicit';
var threadsNum='3';
var down=true;
var pihistory = [];
var historyLimit =5;
var historyIndex=0;
var hostoryCurrent=0;

/////////Functions/////////

$( document ).ready(function() {
	// $( '#historyLeft' ).tooltip({
	// 	position: { my: "left top+15", at: "left bottom", collision: "flipfit" }
	// 	//tooltipClass: "my-tooltip-styling" 
	// 	 // open: function (event, ui) {
 //   //       	ui.tooltip.css("max-height", "1px");
 //   //   }
	// });
	//function supportsSSE() {
  	//	alert('no support for server side events');
	//};
	//var eventSource = new EventSource("http://localhost/implicit/PITracking");
	// eventSource.onopen = function(event) {
	// 	//alert('connection established');
	// 	  // handle open event
	// };
	//  eventSource.onmessage = function(event) {
	//  	console.log('message');
 //        if (event.type == 'progress') {
 //        	console.log(evenet.data);
 //        }
	// };
	$('#historyRight').on('click',function(){

		if (historyCurrent===historyIndex) return;
		historyCurrent++;
		var historyObj = pihistory[historyCurrent-1];
		var csv = historyObj.csv;
		var data = historyObj.data;
		if (data.db==='Research'){
			$(document).find('#dbButton').html('<span class="ui-button-text">Research <i class="icon-caret-down" ></i>');
		}
		if (data.db==='Demo'){
			$(document).find('#dbButton').html('<span class="ui-button-text">Demo <i class="icon-caret-down" ></i>');
			$(document).find('#buttonStudies').html('<span class="ui-button-text">Any <i class="icon-caret-down" ></i>');
			dbChoise='demo';
			$("#buttonStudies").button("option", "disabled", true);
		}
		if (data.current==='Both'){
			$(document).find('#dbButton').html('<span class="ui-button-text">Both <i class="icon-caret-down" ></i>');
			$(document).find('#buttonStudies').html('<span class="ui-button-text">Any <i class="icon-caret-down" ></i>');
			dbChoise = 'both';
			$("#buttonStudies").button("option", "disabled", true);
			$('#dataC').prop('checked', true);
		}
		if (data.current==='Current'){
			$(document).find('#buttonStudies').html('<span class="ui-button-text">Current <i class="icon-caret-down" ></i>');
		}
		if (data.current==='History'){
			$(document).find('#buttonStudies').html('<span class="ui-button-text">History <i class="icon-caret-down" ></i>');
		}
		if (data.current==='Any'){
			$(document).find('#buttonStudies').html('<span class="ui-button-text">Any <i class="icon-caret-down" ></i>');
		}
		if (data.studyc === 'true'){
			$('#studyC').prop('checked', true);
		}else{
			$('#studyC').prop('checked', false);
		}
		if (data.taskc === 'true'){
			$('#taskC').prop('checked', true);
		}else{
			$('#taskC').prop('checked', false);
		}
		if (data.datac=== 'true'){
			$('#dataC').prop('checked', true);
		}else{
			$('#dataC').prop('checked', false);
		}
		if (data.timec=== 'true'){
			$('#timeC').prop('checked', true);
			$('#timeTable').fadeIn();
		}else{
			$('#timeC').prop('checked', false);
			$('#timeTable').fadeOut();
		}
		if (data.dayc ==='true'){
			$('#dayC').prop('checked', true);
		}else{
			$('#dayC').prop('checked', false);
		}
		if (data.weekc=== 'true'){
			$('#weekC').prop('checked', true);
		}else{
			$('#weekC').prop('checked', false);
		}
		if (data.monthc=== 'true'){
			$('#monthC').prop('checked', true);
		}else{
			$('#monthC').prop('checked', false);
		}
		if (data.yearc ==='true'){
			$('#yearC').prop('checked', true);
		}else{
			$('#yearC').prop('checked', false);
		}
		if (data.zero ==='true'){
			$('#zero').prop('checked', true);
		}else{
			$('#zero').prop('checked', false);
		}
		
		$(document).find('#studyI').val(data.study);
		$(document).find('#taskI').val(data.task);
		$(document).find('#sinceI').val(data.since);
		$(document).find('#untilI').val(data.until);
		$(document).find('#completedI').val(data.endTask);
		$(document).find('#filterI').val(data.filter);
		setTable(csv);
		resultCVS= csv;
	});
	$('#historyLeft').on('click',function(){
		if (historyCurrent===1) return;
		historyCurrent--;
		var historyObj = pihistory[historyCurrent-1];
		var csv = historyObj.csv;
		var data = historyObj.data;
		if (data.db==='Research'){
			$(document).find('#dbButton').html('<span class="ui-button-text">Research <i class="icon-caret-down" ></i>');
		}
		if (data.db==='Demo'){
			$(document).find('#dbButton').html('<span class="ui-button-text">Demo <i class="icon-caret-down" ></i>');
			$(document).find('#buttonStudies').html('<span class="ui-button-text">Any <i class="icon-caret-down" ></i>');
			dbChoise='demo';
			$("#buttonStudies").button("option", "disabled", true);
		}
		if (data.current==='Both'){
			$(document).find('#dbButton').html('<span class="ui-button-text">Both <i class="icon-caret-down" ></i>');
			$(document).find('#buttonStudies').html('<span class="ui-button-text">Any <i class="icon-caret-down" ></i>');
			dbChoise = 'both';
			$("#buttonStudies").button("option", "disabled", true);
			$('#dataC').prop('checked', true);
		}
		if (data.current==='Current'){
			$(document).find('#buttonStudies').html('<span class="ui-button-text">Current <i class="icon-caret-down" ></i>');
			$("#buttonStudies").button("option", "disabled", false);
		}
		if (data.current==='History'){
			$(document).find('#buttonStudies').html('<span class="ui-button-text">History <i class="icon-caret-down" ></i>');
			$("#buttonStudies").button("option", "disabled", false);
		}
		if (data.current==='Any'){
			$(document).find('#buttonStudies').html('<span class="ui-button-text">Any <i class="icon-caret-down" ></i>');
		}
		if (data.studyc === 'true'){
			$('#studyC').prop('checked', true);
		}else{
			$('#studyC').prop('checked', false);
		}
		if (data.taskc === 'true'){
			$('#taskC').prop('checked', true);
		}else{
			$('#taskC').prop('checked', false);
		}
		if (data.datac=== 'true'){
			$('#dataC').prop('checked', true);
		}else{
			$('#dataC').prop('checked', false);
		}
		if (data.timec=== 'true'){
			$('#timeC').prop('checked', true);
			$('#timeTable').fadeIn();
		}else{
			$('#timeC').prop('checked', false);
			$('#timeTable').fadeOut();

		}
		if (data.dayc ==='true'){
			$('#dayC').prop('checked', true);
		}else{
			$('#dayC').prop('checked', false);
		}
		if (data.weekc=== 'true'){
			$('#weekC').prop('checked', true);
		}else{
			$('#weekC').prop('checked', false);
		}
		if (data.monthc=== 'true'){
			$('#monthC').prop('checked', true);
		}else{
			$('#monthC').prop('checked', false);
		}
		if (data.yearc ==='true'){
			$('#yearC').prop('checked', true);
		}else{
			$('#yearC').prop('checked', false);
		}
		if (data.zero ==='true'){
			$('#zero').prop('checked', true);
		}else{
			$('#zero').prop('checked', false);
		}
		$(document).find('#studyI').val(data.study);
		$(document).find('#taskI').val(data.task);
		$(document).find('#sinceI').val(data.since);
		$(document).find('#untilI').val(data.until);
		$(document).find('#completedI').val(data.endTask);
		$(document).find('#filterI').val(data.filter);
		setTable(csv);
		resultCVS= csv;
	});
	// eventSource.addEventListener('progress', function(event) {
 //        $('.progress-bar').css('width', event.data+'%').attr('aria-valuenow', event.data);
	// }, false);
	//Init////////////////////////
	$("#sinceIcon").click(function() { 
  		$("#sinceI").datepicker( "show" );
  	});
  	
  	$("#untilIcon").click(function() { 
  		$("#untilI").datepicker( "show" );
  	});
  	//////////////////////////////////////////
	$('button').button();
	//////////////////////////////////////////
	$('#studyC').prop('checked', true);
	//$("#sinceI").datepicker({defaultDate: '01/01/1985'});
	$("#sinceI").datepicker();
	$("#untilI").datepicker();
	$('#timeTable').hide();
	//$("#buttonStudies").button("option", "disabled", true);
	//$('#alert').css("display", "none");
	// $( "#historyLeft" ).tooltip({
	//     position: {
	//         my: "center top+15",
	//         at: "center bottom",
	//         using: function( position, feedback ) {
	//             $( this ).css( position );
	//             $( "&lt;div&gt;" )
	//             .addClass( "arrow top" )
	//             .addClass( feedback.vertical )
	//             .addClass( feedback.horizontal )
	//             .appendTo( this );
	//         }
	//     }
	// });
	$("#dialog").dialog({
	    autoOpen: false,
	    width: 600,
	    position: 'center',
	    modal: true,
	    buttons: {
	        'Cancel request' : function () {
	            $(this).dialog("close");
	        },
	        'Continue with the request' : function () {
	        	$(this).dialog("close");	
	        	$('#CSVTable').html("");
				$("#gif").css("display", "block");
				$('#alert').css("display", "none");
				var data = getData();
				postForm(data);
	        }
	        
	    }
	});
	$("#dialog2").dialog({
	    autoOpen: false,
	    width: 600,
	    position: 'center',
	    modal: true,
	    buttons: {
	        'Ok' : function () {
	            $(this).dialog("close");
	        }
	    }
	});

	$("#downloadDialog").dialog({
	    autoOpen: false,
	    width: 600,
	    position: "top", 
	    modal: true,
	    buttons: {
	        'Ok' : function () {
	        	csvName = $('#downloadI').val();
	        	var blob = new Blob([resultCVS], {type: "text/plain;charset=utf-8"});
        		saveAs(blob,csvName+'.csv');
	            $(this).dialog("close");
	        },
	        'Cancel' : function () {
	        	$(this).dialog("close");

	        }
	    }
	});

	$("#cpanel").dialog({
	    autoOpen: false,
	    width: 600,
	    position: 'center',
	    modal: true,
	    buttons: {
	        'Ok' : function () {
	        	//alert($('#provider').val());
	        	
	        	/////////
	        	if ( $('#provider').val()==='path') method='1';
				if ( $('#provider').val()==='back') method='2';
				if ( $('#provider').val()==='url') method='3';
				refresh = $('#refresh').val();
				test = $('#connect').val();
				threads = $('#threads').val();
				curl = $('#curl').val();
				hurl = $('#hurl').val();
				cpath = $('#cpath').val();
				hpath = $('#hpath').val();
				threadsNum = $('#threadsNum').val();
				baseURL = $('#baseURL').val();
				console.log('method: '+method+' connect: '+test+' refresh: '+refresh+' curl: '+curl+' hurl: '+hurl+' cpath: '+cpath+' hpath: '+hpath+' threads: '+threads+ 'threadsNum '+threadsNum);
	            $(this).dialog("close");
	        }
	    }
	});

	$("#dialog3").dialog({
	    autoOpen: false,
	    width: 600,
	    position: 'center',
	    modal: true,
	    buttons: {
	        'Ok' : function () {
	            $(this).dialog("close");
	        }
	    }
	});
	$('#refresh').val(refresh);
	if (method==='1') $('#provider').val('path');
	if (method==='2') $('#provider').val('back');
	if (method==='3') $('#provider').val('url');
	if (test==='newwarehouse') $('#connect').val('newwarehouse');
	$('#curl').val(curl);
	$('#hurl').val(hurl);
	$('#cpath').val(cpath);
	$('#hpath').val(hpath);
	$('#threadsNum').val(threadsNum);
	$('#baseURL').val(baseURL);
////////////////////////
 
    ///this works
    $(document).keydown(function(e){
	    if(e.ctrlKey){
	        ctrlMode = true;
	    };
    });

    $(document).keyup(function(e){
    	ctrlMode = false;
    });

	$(document).keydown(function(e){
		 if (e.which==77){

		 	if (ctrlMode===true){
		 		$('#cpanel').dialog('open');
		 	}
		 }
	});
	
	$('#filterI').on('keyup',function(){

		var val = $('#studyI').val();
		if (lastStudyVal==='' ){

			$('#studyC').prop('checked',true);
		 }
		 lastStudyVal = val;



	});
	// $('#taskI').on('keyup',function(){
		
	// 	var val = $('#taskI').val();
	// 	if (lastTaskVal==='' ){

	// 		$('#taskC').prop('checked',true);
	// 	 }
	// 	 lastTaskVal = val;
		
	// });




	 $('#timeC').on('click',function(){
		 if ($('#timeC').is(":checked")){
		 	$('#monthC').prop('checked', true);
		 	$('#weekC').prop('checked', false);
		 	$('#dayC').prop('checked', false);
		 	$('#yearC').prop('checked', false);
			$('#timeTable').fadeIn();
			
		 }else{
		 	
		 	$('#timeTable').fadeOut();
		 }
		
	 });
	$(document).find('#currentLi').on('click',function(){
		
		$(document).find('#buttonStudies').html('<span class="ui-button-text">Current <i class="icon-caret-down" ></i>');
		currentChoise='current;'

	});
	$(document).find('#HistoryLi').on('click',function(){
		
		$(document).find('#buttonStudies').html('<span class="ui-button-text">History <i class="icon-caret-down" ></i>');
		currentChoise = 'history';

	});
	$(document).find('#AllLi').on('click',function(){
		
		$(document).find('#buttonStudies').html('<span class="ui-button-text">Any <i class="icon-caret-down" ></i>');
		currentChoise = 'all';

	});
	$(document).find('#DemoLi').on('click',function(){
		
		$(document).find('#dbButton').html('<span class="ui-button-text">Demo <i class="icon-caret-down" ></i>');
		$(document).find('#buttonStudies').html('<span class="ui-button-text">Any <i class="icon-caret-down" ></i>');
		dbChoise='demo';
		$("#buttonStudies").button("option", "disabled", true);

	});
	$(document).find('#ResearchLi').on('click',function(){
		
		$(document).find('#dbButton').html('<span class="ui-button-text">Research <i class="icon-caret-down" ></i>');
		$(document).find('#buttonStudies').html('<span class="ui-button-text">Current <i class="icon-caret-down" ></i>');
		dbChoise = 'research';
		$("#buttonStudies").button("option", "disabled", false);
		
		

	});
	$(document).find('#BothLi').on('click',function(){
		
		$(document).find('#dbButton').html('<span class="ui-button-text">Both <i class="icon-caret-down" ></i>');
		$(document).find('#buttonStudies').html('<span class="ui-button-text">Any <i class="icon-caret-down" ></i>');
		dbChoise = 'both';
		$("#buttonStudies").button("option", "disabled", true);
		$('#dataC').prop('checked', true);


	});
	$('#dayC').on('click', function(){
		if ($('#dayC').is(":checked")){
			$('#weekC').prop('checked', false);
			$('#monthC').prop('checked', false);
			$('#yearC').prop('checked', false);
		}
	});
	$('#weekC').on('click', function(){
		if ($('#weekC').is(":checked")){
			$('#dayC').prop('checked', false);
			$('#monthC').prop('checked', false);
			$('#yearC').prop('checked', false);
		}
	});
	$('#monthC').on('click', function(){
		if ($('#monthC').is(":checked")){
			$('#weekC').prop('checked', false);
			$('#dayC').prop('checked', false);
			$('#yearC').prop('checked', false);
		}
	});
	$('#yearC').on('click', function(){
		if ($('#yearC').is(":checked")){
			$('#weekC').prop('checked', false);
			$('#monthC').prop('checked', false);
			$('#dayC').prop('checked', false);
		}
	});

	$('#collapse').on('click', function(){
		
		if (down==true){
        $("#instruct1").slideDown("slow");
        //$("#collapse span span").text('Show');

        down=false;

      }else{
        $("#instruct1").slideUp("slow");
        down=true;
        //$("#collapse span span").text('Hide');

      }

	});

	
	download = function(){
		window.scrollTo(0,0);
		$('#downloadDialog').dialog('open');
	}
  	
	
	getData = function(){

		var data = {};
		var curr = $(document).find('#buttonStudies').html();
		var start = curr.indexOf('">');
		var index = curr.indexOf('<i');
		curr = curr.substr(start+2,index-start-3);
		var db = $(document).find('#dbButton').html();
		start = db.indexOf('">');
		var index2 = db.indexOf('<i');
		db = db.substr(start+2,index2-start-3);
		data.current = curr;
		data.db = db;
		data.study = $(document).find('#studyI').val();
		data.task = $(document).find('#taskI').val();
		data.since = $(document).find('#sinceI').val();
		data.until = $(document).find('#untilI').val();
		data.endTask=$(document).find('#completedI').val();
		data.filter = $(document).find('#filterI').val();

		if ($('#studyC').is(":checked")){
			data.studyc = 'true';
		}else{
			data.studyc = '';
		}
		if ($('#taskC').is(":checked")){
			data.taskc = 'true';
		}else{
			data.taskc = '';
		}
		if ($('#dataC').is(":checked")){
			data.datac = 'true';
		}else{
			data.datac = '';
		}
		if ($('#timeC').is(":checked")){
			data.timec = 'true';
		}else{
			data.timec = '';
		}
		if ($('#dayC').is(":checked")){
			data.dayc = 'true';
		}else{
			data.dayc = '';
		}
		if ($('#weekC').is(":checked")){
			data.weekc = 'true';
		} else{
			data.weekc = '';
		}
		if ($('#monthC').is(":checked")){
			data.monthc = 'true';
		}else{
			data.monthc = '';
		}
		if ($('#yearC').is(":checked")){
			data.yearc = 'true';
		}else{
			data.yearc = '';

		}
		if ($('#zero').is(":checked")){
			data.zero = 'true';
		}else{
			data.zero = '';

		}
		data.testDB = test;
		data.method = method;
		data.refresh =refresh;
		data.curl=curl;
		data.hurl=hurl;
		data.cpath=cpath;
		data.hpath=hpath;
		data.tasksM='3';
		data.threads = threads;
		data.threadsNum = threadsNum;
		data.baseURL = baseURL;
		return data;

	}

	handleZero = function(csv){

		var AnelysedCSV='';
		if( ($('#zero').is(':checked')) ){
		
			 var lines =csv.split("\n");
			 var commas = lines[0].split(",");
			 var index;
			  for (var i=0;i<commas.length;i++){
			  	if (commas[i]==='Started'){
			  		index=i;
			  	}
			  }
			  for(var i = lines.length - 1; i >= 0; i--) {
			  	var line = lines[i];
			  	var lineCommas = line.split(",");
			  	var started  = lineCommas[index];
			  	if (started==='0'){
			  		lines.splice(i,1);
					
			  	}
			  }
			
			for (var i=0;i<lines.length;i++){
				AnelysedCSV += lines[i]+'\n';
			}
			return AnelysedCSV;
		}else{
			return csv;
		}
		
	}
	setHistory = function(csv,data){
		var historyObj={};
		historyObj.csv = csv;
		historyObj.data = data;
		//var length = pihistory.length;
		//pihistory[length] = historyObj;
		pihistory.push(historyObj);
		historyIndex++;
		historyCurrent=historyIndex;

	}
	postForm = function(Reqdata){

		$.post( '/implicit/PITracking', JSON.stringify(Reqdata))
		.done(function( data ) {
			
		  	resultCVS = data;
		  	//csv = data;
		  	resultCVS = handleZero(resultCVS);
		  	setHistory(resultCVS,Reqdata);
		  	if (resultCVS!="\r\n" || resultCVS===undefined || resultCVS===null || resultCVS===''||resultCVS==':logger:'){
		  		
			    $('#result').val(data);
			    console.log(resultCVS);
			    $("#gif").css("display", "none");
			 //    $(function() {
			    	
	  	// 			$('#CSVTable').CSVToTable(resultCVS,{
	  	// 				tableClass:'tablesorter'
	  	// 			}).bind("loadComplete",function() { 
	  	// 				$('#CSVTable').find('#cvsT').addClass('tablesorter');
	  	// 				$('#CSVTable').find('table').tablesorter();
				// 	});
				// });
				setTable(resultCVS);
		  	}else{
		  		$("#gif").css("display", "none");
		  		//$('#dialog').dialog('open');
		  		$('#alert').css("display", "block");

		  	}
		  	
		});

	}
	setTable = function(resultCVS){
		$('#CSVTable').CSVToTable(resultCVS,{
 				tableClass:'tablesorter'
    			}).bind("loadComplete",function() { 
 				$('#CSVTable').find('#cvsT').addClass('tablesorter');
 				$('#CSVTable').find('table').tablesorter();
	 	});
	}
	isEmpty = function (value){
		if (value==='') return true;
		if (value===undefined) return true;
		if (value===null) return true;
		return false;
	}
	submit= function(){
		console.log('start submit');
		
		var studyI = $(document).find('#studyI').val();
		var taskI  = $(document).find('#taskI').val();
		var sinceI = $(document).find('#sinceI').val();
		var untilI = $(document).find('#untilI').val();
		var curr = $(document).find('#buttonStudies').html();
		var start = curr.indexOf('">');
		var index = curr.indexOf('<i');
		curr = curr.substr(start+2,index-start-3);
		if(Date.parse(untilI)<Date.parse(sinceI)){ 
			alert('Please enter correct dates');
			return;
		}
		if (untilI=='') {
			var currentdate = new Date(); 
			var datetime =  (currentdate.getMonth()+1)+"/"+currentdate.getDate()+"/"+currentdate.getFullYear();
			untilI= datetime;
			$(document).find('#untilI').val(untilI);
		}
		if (sinceI==''){
			 var currentdate = new Date(); 
			 var datetime =  (currentdate.getMonth())+"/01/"+currentdate.getFullYear();

			 sinceI = datetime;
			 $(document).find('#sinceI').val(sinceI);
		}
		
		if (isEmpty(studyI) && (curr=='History')){
			//$('#dialog2').dialog('open');
			//return;
		}
		if (isEmpty(studyI) && (curr=='Any')){
			//$('#dialog').dialog('open');
			//return;
		}
		if (curr=='History' && $('#taskC').is(":checked") ){
			//alert('History studies are restricted to show by study only');
			//return;
		}
		if ($('#timeC').is(":checked") && (!($('#sinceI').val()) || !($('#untilI').val())) ){
			// $('#dialog3').dialog('open');
			// return;
		}

		if(isEmpty(studyI) && curr=='Any'){

			$('#dialog').dialog('open');

		}else{
			$('#CSVTable').html("");
			$("#gif").css("display", "block");
			$('#alert').css("display", "none");
			var data = getData();
			postForm(data);

		}

	}

});



</script>
</head>


<body>
	
<div class="container">
	<!--<div id="instruct1">
		<font color="DarkGray">Select Demo or Research studies. If you select Research, select &quot;Current&quot; for studies using PI's participant pool right now, &quot;History&quot; for any study that has ever used PI&rsquo;s participant pool, and &quot;Any&quot; for any research study regardless of whether it has ever used PI&rsquo;s participant pool.</font>
		
	</div>!-->
	
	<div>
		<button class="ui-button-primary" id="dbButton" data-dropdown="#dropdown-2" id="buttonDB">Research <i class="icon-caret-down" style="margin-left:10px;"></i></button>
		<button class="ui-button-primary "  id="buttonStudies" data-dropdown="#dropdown-1">Current <i class="icon-caret-down" ></i></button>
		
		<button id="submit" onclick="submit()" class="ui-button-success" style="margin-left:10px;">Submit</button>
		<div style="margin-left:28%;display:inline">
			<i id="historyLeft" style="color:#3333CC;" class="fa fa-caret-square-o-left" title="backward"></i>
			<i id="historyRight" style="color:#3333CC;margin-left:4px;" class="fa fa-caret-square-o-right" title="forward"></i>
		</div>
		
		<button id="collapse" class="ui-button-primary" >Instructions <i class="icon-sort-down"></i></button>
	 
	<div>
	
	
	
	<div id="instruct1" >
		<font color="DarkGray">Choose whether you want participation data from the demo site, the research site, or both. You can also choose &quot;current&quot; (to get participation data from those studies that are in the pool right now), &quot;history&quot; (to get data from studies that have ever been in the research pool), or &quot;any&quot; (to get data from all research studies, regardless of whether or not they have ever been in the pool).</br></br>
 
		Enter the study id or any part of the study id (the study name that that appears in an .expt file). Note that the study id search feature is case-sensitive. If you leave this box blank you will get data from all studies within your specified time period.</br></br>
 
		You can also enter a task name or part of a task name (e.g., realstart) if you only want participation data from certain tasks. You can also choose how you want the data displayed. If you click &quot;Study&quot;, you will see data from any study that meets your search criteria. If you also check &quot;Task&quot; you will see data from any study that meets your search criteria separated out by task. The &quot;Data Group&quot; option will allow you to see whether a given study is coming from the demo or research site.</br></br>

		You can define how completion rate is calculated by setting &quot;start&quot; and &quot;completed&quot;. Only studies that visited those tasks would be used in the calculation.</font>
	</div>	
	<!--
	<div id="instruct2">
		<font color="DarkGray">Enter the study id or any part of the study id. You can also enter the task name (or a part of the task name) if you want to see only specific tasks.</font>
	</div> !-->
	</br>
	
	<div >

		<span style="font-style:italic;">Read by: </span></br>
			<div style="margin-top:8px;">
				<div id="enterStudy"  class="inline" style="padding-right:10px;">
					<label>Study Name: </label>
					<input id="studyI" type="text" id="studyName"></input>
				</div>
				<div id="enterStudy"  class="inline" style="padding-right:10px;">
					<label>Task Name: </label>
					<input id="filterI" type="text" id="taskName"></input>
				</div>
				<div id="enterStudy"  class="inline" style="padding-right:10px;">
					<label>Since: </label>
					<input id="sinceI" type="text" style="margin-left:39px;"></input><i id="sinceIcon" class="icon-calendar" style="margin-left:5px;"></i> 
				</div>
				<div id="enterStudy"  class="inline" style="padding-right:10px;">
					<label>Until: </label>
					<input id="untilI" type="text" id="until" type="text" ></input><i id="untilIcon"  class="icon-calendar" style="margin-left:5px;"></i>
				</div>
			</div>
	<div>
	
	<span id="view" style="position:relative;left:-40px;top:4px;">
			
				<div style="display:inline-block;">
					<ul style="list-style-type: none;">
    					<li><span style="font-style:italic;">Show by (or combination of those): </span></li>
    					<!--<li><label>(or combination of those)</label></li>!-->
    					
  					</ul>
  				</div>
  			
  				<div style="display:inline-block;padding:10px;margin-left:20px;margin-top:-10px;">
					<input id="studyC" type="checkbox" name="sports" value="soccer" style="margin-left:10px;"/> Study
					<input id="taskC" type="checkbox" name="sports" value="soccer" style="margin-left:13px;" /> Task
					<input id="dataC" type="checkbox" name="sports" value="soccer" style="margin-left:13px;" /> Data Group
					<input id="timeC" type="checkbox" name="sports" value="soccer" style="margin-left:13px;" /> Time
					<div id="timeTable" style="display:inline-block;border:1px solid;padding:10px;">
						 <input id="dayC" type="checkbox" name="sports" value="soccer"  />D
						 <input id="weekC" type="checkbox" name="sports" value="soccer"  />W
						 <input id="monthC" type="checkbox" name="sports" value="soccer"  />M
						 <input id="yearC" type="checkbox" name="sports" value="soccer"  />Y

					</div>
				</div>

		</span>
		
	<div style="margin-top:12px;">
		<div style="display:inline;">
			<span style="font-style:italic;">Compute completion:  </span>
		</div>
		
		<div id="enterStarted"  class="inline" style="margin-left:80px;">
			<label>First Task: </label>
			<input id="taskI" type="text" style="margin-left:8px;"></input>
			<label style="margin-left:10px;">Last Task: </label>
			<input id="completedI" type="text" style="margin-left:8px;"></input>
		</div>
		
</div>		
		
		<div style="margin-top:17px;">
			<span style="font-style:italic;">More options: </span>
			<div style="display:inline">
				
					
				
				<div style="margin-top:2px;display: inline;"><input id="zero" type="checkbox" name="sports" value="soccer"  />Hide Rows with Zero Started Sessions</div>
				<button id="download" onclick="download()" class="ui-button-primary ui-btn-sm" style="margin-left:10px; display:inline;">Download CSV</button>
				</br>
			</div>
		</div>
		

	<hr width="70%" align="left" style="margin-top:17px;"><!-- hr line ! -->

	
	<p>
		<div id="alert"class="ui-widget" style="display: none;width:82%;">
		    <div class="ui-state-default ui-corner-all">
		        <p><span class="ui-icon ui-icon-info" style="float: left; margin-right: .3em;"></span>
		             No data match your request.</p>
		    </div>
		</div>
		<img id="gif" src="img/loading.gif"  style="display:none;margin-left:40%;">
		<!--<div class="progress progress-striped">
  			<div class="progress-bar progress-bar-info" role="progressbar" aria-valuenow="20" aria-valuemin="0" aria-valuemax="100" style="width: 0%">
    			<span class="sr-only">0% Complete</span>
  			</div>
		</div>!-->
		<div id="CSVTable" style="width:82%"></div>
	</p>

</div>	

	


<div id="dropdown-1" class="dropdown dropdown-tip">
    <ul class="dropdown-menu" id="uldrop1">
        <li id="currentLi"><a href="#1">Current</a></li>
        <li id="HistoryLi"><a href="#2">History</a></li>
        <li id="AllLi"><a href="#3">Any</a></li>
    </ul>
</div>
<div id="dropdown-2" class="dropdown dropdown-tip">
    <ul class="dropdown-menu" id="uldrop2">
        <li id="DemoLi"><a href="#1">Demo</a></li>
        <li id="ResearchLi"><a href="#2">Research</a></li>
        <li id="BothLi"><a href="#3">Both</a></li>
    </ul>
</div>
<div id="dialog" title="Long search warning">
        <p><font size=2>This might take a while. Are you sure you do not want to enter any conditions to limit your search?</font></p>

</div>
<div id="dialog2" title="Study Name">
        <p><font size=2>Please provide study name to restrict your search</font></p>

</div>
<div id="downloadDialog" title="File Name">
        <p>
        	<font size=2>Please Provide File Name: </font>&nbsp&nbsp
        	<input id="downloadI" type="text" value=""></input>
        </p>

</div>
<div id="dialog3" title="Study Name Missing">
        <p><font size=2>Please Provide Since/Until Date</font></p>
</div>
<div id="cpanel" title="Control Panel">
        <p><font size=2>Study List Provider: </font>
	        <select id="provider">
	  			<option value="path">Path</option>
	  			<option value="url">URL</option>
	  			<option value="back">Backend</option>
			</select>
			&nbsp&nbsp
			<font size=2>Caching: </font>
			<select id="refresh">
	  			<option value="no">No Caching</option>
	  			<option value="1">1</option>
			</select></br></br>
			<font size=2>URL for Current Studies: </font>
			<input id="curl" type="text" value="" style="width:400px;"> </input></br>
			<font size=2>URL for History Studies: </font>
			<input id="hurl" type="text" value="" style="width:400px;"></input></br>
			<font size=2>Path for Current Studies: </font>		
			<input id="cpath" type="text" value="" style="width:400px;"></input></br>
			<font size=2>Path for History Studies: </font>		
			<input id="hpath" type="text" value="" style="width:400px;"></input>

		</p>
		<p>
			<font size=2>Connect to: </font></br>			
			<select  id="connect">
				<option value="test">Test</option>
				<option value="oldwarehouse">Old warehouse</option>
				<option value="newwarehouse">New warehouse</option>

			</select>
		</p>
		<p>
			<font size=2>Use Threads: </font></br>			
			<select  id="threads">
				<option value="yes">Yes</option>
				<option value="no">no</option>
			</select><br/>
			Number of Threads: <input id="threadsNum" type="text" value="3" style="width:200px;"> </input></br>
			BaseURL: <input id="baseURL" type="text" value="" style="width:400px;"> </input></br>


</div>
<script type="text/javascript" src="js/FileSaver.js"></script>
</body>


</html>