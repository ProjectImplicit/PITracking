<html>
<head>
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<!--sources----------------------!-->

<!-- Latest compiled and minified CSS -->
<!--<link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.0.3/css/bootstrap.min.css">!-->

<!-- Optional theme -->
<!--<link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.0.3/css/bootstrap-theme.min.css">!-->

<link href="css/custom-theme/jquery-ui-1.10.0.custom.css" rel="stylesheet">
<!--<link href="css/bootstrap.min.css" rel="stylesheet">!-->
<link rel="stylesheet" href="js/tablesorter/themes/blue/style.css" type="text/css" id="" media="print, projection, screen" />
<link type="text/css" rel="stylesheet" href="css/jquery.dropdown.css" />
<link href="//netdna.bootstrapcdn.com/font-awesome/3.2.1/css/font-awesome.css" rel="stylesheet">
	<!---------------------------------!-->
<script src="//code.jquery.com/jquery-1.10.2.min.js"></script>

<!--<script src="js/jquery-ui-1.10.3.custom.js"></script>!-->
<script src="js/jquery-ui-1.10.3.custom.min.js"></script>
<script src="js/jquery.csvToTable.js"></script>
<script type="text/javascript" src="js/tablesorter/jquery.tablesorter.js"></script> 
<script type="text/javascript" src="js/jquery.dropdown.js"></script>
<title>PI stats</title>
<!-- Latest compiled and minified JavaScript -->
<!--<script src="//netdna.bootstrapcdn.com/bootstrap/3.0.3/js/bootstrap.min.js"></script>!-->
<style>
.inline{
	display: inline-block;
}

.container{
	margin-top:50px;
	margin-left:8%;
	margin-right:10%;
	
	
	
}

.ui-icon{
	display:inline-block;
	margin-left:2px;
}
#instruct1{
	
	font-family: "Times New Roman";
	width:65%;
	margin-bottom: 35px;
	display:none;

}
#instruct2{
	
	margin-top:15px;
	margin-bottom:20px;
}
#collapse{
	width:107px;
	height:22px;
	position:absolute;
	left:53%;
	line-height:auto;
	padding: 2px 10px 15px 10px;
	border-radius: 7px;
	/*margin-left:36%;*/



}

</style>
<script>
/////////Globals///////////
var csv;
var submit;
var resultCVS;
var dbChoise;
var currentChoise;
var lastTaskVal ='';
var lastStudyVal ='';
var test = 'newwarehouse';
var ctrlMode = false; 
var method='3';
var refresh ='no';
var threads='yes';

//var curl='http://dw2.psyc.virginia.edu/implicit/research/library/randomStudiesConfig/RandomStudiesConfig.xml';
//var hurl='http://dw2.psyc.virginia.edu/implicit/research/library/randomStudiesConfig/HistoryRand.xml';
//var cpath='research/library/randomStudiesConfig/RandomStudiesConfig.xml';
//var hpath='research/library/randomStudiesConfig/HistoryRand.xml';
//var baseURL='http://dw2.psyc.virginia.edu/implicit';
var curl='http://app-dev-01.implicit.harvard.edu/implicit/research/library/randomStudiesConfig/RandomStudiesConfig.xml';
var hurl='http://app-dev-01.implicit.harvard.edu/implicit/research/library/randomStudiesConfig/HistoryRand.xml';
var cpath='research/library/randomStudiesConfig/RandomStudiesConfig.xml';
var hpath='research/library/randomStudiesConfig/HistoryRand.xml';
var baseURL='http://app-dev-01.implicit.harvard.edu/implicit';
var threadsNum='3';
var down=true;

/////////Functions/////////



</script>
<script>

$( document ).ready(function() {


	//Init////////////////////////
	$("#sinceIcon").click(function() { 
  		$("#sinceI").datepicker( "show" );
  	});
  	
  	$("#untilIcon").click(function() { 
  		$("#untilI").datepicker( "show" );
  	});
  	//////////////////////////////////////////
	$('button').button();
	//////////////////////////////////////////
	$('#studyC').prop('checked', true);
	//$("#sinceI").datepicker({defaultDate: '01/01/1985'});
	$("#sinceI").datepicker();
	$("#untilI").datepicker();
	$('#timeTable').hide();
	//$("#buttonStudies").button("option", "disabled", true);
	//$('#alert').css("display", "none");
	$("#dialog").dialog({
	    autoOpen: false,
	    width: 600,
	    position: 'center',
	    modal: true,
	    buttons: {
	        'Cancel request' : function () {
	            $(this).dialog("close");
	        },
	        'Continue with the request' : function () {
	        	$(this).dialog("close");	
	        	$('#CSVTable').html("");
				$("#gif").css("display", "block");
				$('#alert').css("display", "none");
				var data = getData();
				postForm(data);
	        }
	        
	    }
	});
	$("#dialog2").dialog({
	    autoOpen: false,
	    width: 600,
	    position: 'center',
	    modal: true,
	    buttons: {
	        'Ok' : function () {
	            $(this).dialog("close");
	        }
	    }
	});
	$("#cpanel").dialog({
	    autoOpen: false,
	    width: 600,
	    position: 'center',
	    modal: true,
	    buttons: {
	        'Ok' : function () {
	        	//alert($('#provider').val());
	        	
	        	/////////
	        	if ( $('#provider').val()==='path') method='1';
				if ( $('#provider').val()==='back') method='2';
				if ( $('#provider').val()==='url') method='3';
				refresh = $('#refresh').val();
				test = $('#connect').val();
				threads = $('#threads').val();
				curl = $('#curl').val();
				hurl = $('#hurl').val();
				cpath = $('#cpath').val();
				hpath = $('#hpath').val();
				threadsNum = $('#threadsNum').val();
				baseURL = $('#baseURL').val();
				console.log('method: '+method+' connect: '+test+' refresh: '+refresh+' curl: '+curl+' hurl: '+hurl+' cpath: '+cpath+' hpath: '+hpath+' threads: '+threads+ 'threadsNum '+threadsNum);
	            $(this).dialog("close");
	        }
	    }
	});

	$("#dialog3").dialog({
	    autoOpen: false,
	    width: 600,
	    position: 'center',
	    modal: true,
	    buttons: {
	        'Ok' : function () {
	            $(this).dialog("close");
	        }
	    }
	});
	$('#refresh').val(refresh);
	if (method==='1') $('#provider').val('path');
	if (method==='2') $('#provider').val('back');
	if (method==='3') $('#provider').val('url');
	if (test==='newwarehouse') $('#connect').val('newwarehouse');
	$('#curl').val(curl);
	$('#hurl').val(hurl);
	$('#cpath').val(cpath);
	$('#hpath').val(hpath);
	$('#threadsNum').val(threadsNum);
	$('#baseURL').val(baseURL);
////////////////////////
 
    ///this works
    $(document).keydown(function(e){
	    if(e.ctrlKey){
	        ctrlMode = true;
	    };
    });

    $(document).keyup(function(e){
    	ctrlMode = false;
    });

	// $(document).keydown(function(e){
		
	// 		if (e.which==88){
	// 			if (ctrlMode===true){
	// 				if (test==='test'){
	//   				test='warehouse';
	//   				}
	//   				else{
	//   					test='test';
	//   				} 
	//     			alert("changed connection to: "+test);	
	// 		}
	// 	}
		
	// });
	$(document).keydown(function(e){

		

			 if (e.which==77){

			 	if (ctrlMode===true){
			 		$('#cpanel').dialog('open');
			 	}
			 }

			// 		if (method==='1'){
	  // 					method='2';
	  // 					alert("getting studies by using backend");
	  // 				}else{
	  // 					if (method==='2'){
	  // 						method='3';
	  // 						alert("getting studies by using URL");
	  // 					}else{
	  // 						if (method==='3'){
	  // 							method='1';
	  // 							alert("getting studies by using Path");	
	  // 						}
	  // 					}
	  					
	  // 				} 
	    				
			// }
	//	}
		
	});
	
	$('#studyI').on('keyup',function(){

		var val = $('#studyI').val();
		if (lastStudyVal==='' ){

			$('#studyC').prop('checked',true);
		 }
		 lastStudyVal = val;



	});
	$('#taskI').on('keyup',function(){
		
		var val = $('#taskI').val();
		if (lastTaskVal==='' ){

			$('#taskC').prop('checked',true);
		 }
		 lastTaskVal = val;
		 //else{
		// 	$('#taskC').prop('checked',false);
		// }
	});




	 $('#timeC').on('click',function(){
		 if ($('#timeC').is(":checked")){
		 	$('#monthC').prop('checked', true);
		 	$('#weekC').prop('checked', false);
		 	$('#dayC').prop('checked', false);
		 	$('#yearC').prop('checked', false);
			$('#timeTable').fadeIn();
			
		 }else{
		 	
		 	$('#timeTable').fadeOut();
		 }
		
	 });
	$(document).find('#currentLi').on('click',function(){
		
		$(document).find('#buttonStudies').html('<span class="ui-button-text">Current <i class="icon-caret-down" ></i>');
		currentChoise='current;'

	});
	$(document).find('#HistoryLi').on('click',function(){
		
		$(document).find('#buttonStudies').html('<span class="ui-button-text">History <i class="icon-caret-down" ></i>');
		currentChoise = 'history';

	});
	$(document).find('#AllLi').on('click',function(){
		
		$(document).find('#buttonStudies').html('<span class="ui-button-text">Any <i class="icon-caret-down" ></i>');
		currentChoise = 'all';

	});
	$(document).find('#DemoLi').on('click',function(){
		
		$(document).find('#dbButton').html('<span class="ui-button-text">Demo <i class="icon-caret-down" ></i>');
		$(document).find('#buttonStudies').html('<span class="ui-button-text">Any <i class="icon-caret-down" ></i>');
		dbChoise='demo';
		$("#buttonStudies").button("option", "disabled", true);

	});
	$(document).find('#ResearchLi').on('click',function(){
		
		$(document).find('#dbButton').html('<span class="ui-button-text">Research <i class="icon-caret-down" ></i>');
		$(document).find('#buttonStudies').html('<span class="ui-button-text">Current <i class="icon-caret-down" ></i>');
		dbChoise = 'research';
		$("#buttonStudies").button("option", "disabled", false);
		
		

	});
	$(document).find('#BothLi').on('click',function(){
		
		$(document).find('#dbButton').html('<span class="ui-button-text">Both <i class="icon-caret-down" ></i>');
		$(document).find('#buttonStudies').html('<span class="ui-button-text">Any <i class="icon-caret-down" ></i>');
		dbChoise = 'both';
		$("#buttonStudies").button("option", "disabled", true);
		$('#dataC').prop('checked', true);


	});
	$('#dayC').on('click', function(){
		if ($('#dayC').is(":checked")){
			$('#weekC').prop('checked', false);
			$('#monthC').prop('checked', false);
			$('#yearC').prop('checked', false);
		}
	});
	$('#weekC').on('click', function(){
		if ($('#weekC').is(":checked")){
			$('#dayC').prop('checked', false);
			$('#monthC').prop('checked', false);
			$('#yearC').prop('checked', false);
		}
	});
	$('#monthC').on('click', function(){
		if ($('#monthC').is(":checked")){
			$('#weekC').prop('checked', false);
			$('#dayC').prop('checked', false);
			$('#yearC').prop('checked', false);
		}
	});
	$('#yearC').on('click', function(){
		if ($('#yearC').is(":checked")){
			$('#weekC').prop('checked', false);
			$('#monthC').prop('checked', false);
			$('#dayC').prop('checked', false);
		}
	});

	$('#collapse').on('click', function(){
		
		if (down==true){
        $("#instruct1").slideDown("slow");
        //$("#collapse span span").text('Show');

        down=false;

      }else{
        $("#instruct1").slideUp("slow");
        down=true;
        //$("#collapse span span").text('Hide');

      }

	});

	
	download = function(){
		var blob = new Blob([text], {type: "text/plain;charset=utf-8"});
        var name = 'csv';
        saveAs(blob,name+'.xml');

	}
  	
	
	getData = function(){

		var data = {};
		var curr = $(document).find('#buttonStudies').html();
		var start = curr.indexOf('">');
		var index = curr.indexOf('<i');
		curr = curr.substr(start+2,index-start-3);
		var db = $(document).find('#dbButton').html();
		start = db.indexOf('">');
		var index2 = db.indexOf('<i');
		db = db.substr(start+2,index2-start-3);
		data.current = curr;
		data.db = db;
		data.study = $(document).find('#studyI').val();
		data.task = $(document).find('#taskI').val();
		data.since = $(document).find('#sinceI').val();
		data.until = $(document).find('#untilI').val();

		if ($('#studyC').is(":checked")){
			data.studyc = 'true';
		}else{
			data.studyc = '';
		}
		if ($('#taskC').is(":checked")){
			data.taskc = 'true';
		}else{
			data.taskc = '';
		}
		if ($('#dataC').is(":checked")){
			data.datac = 'true';
		}else{
			data.datac = '';
		}
		if ($('#timeC').is(":checked")){
			data.timec = 'true';
		}else{
			data.timec = '';
		}
		if ($('#dayC').is(":checked")){
			data.dayc = 'true';
		}else{
			data.dayc = '';
		}
		if ($('#weekC').is(":checked")){
			data.weekc = 'true';
		} else{
			data.weekc = '';
		}
		if ($('#monthC').is(":checked")){
			data.monthc = 'true';
		}else{
			data.monthc = '';
		}
		if ($('#yearC').is(":checked")){
			data.yearc = 'true';
		}else{
			data.yearc = '';

		}
		data.testDB = test;
		data.method = method;
		data.refresh =refresh;
		data.curl=curl;
		data.hurl=hurl;
		data.cpath=cpath;
		data.hpath=hpath;
		data.tasksM='3';
		data.threads = threads;
		data.threadsNum = threadsNum;
		data.baseURL = baseURL;
		return data;

	}

	takeCommasFromStudyID = function(csv){
		// var lines =csv.split("\n");
		// var commas = lines[0].split(",").length;
		// for(var i = lines.length - 1; i >= 0; i--) {
		// 	var line = lines[i];
		// 	var lineCommas = line.split(",").length;
		// 	if (lineCommas!=commas){
		// 		lines.splice(i,1);
				
		// 	}
		// }

		//alert(csv);
		//String line =
	}
	postForm = function(data){

		$.post( '/implicit/PITracking', JSON.stringify(data))
		.done(function( data ) {
		  	resultCVS = data;
		  	cvs = data;
		  	takeCommasFromStudyID(resultCVS);
		  	if (resultCVS!="\r\n" || resultCVS===undefined || resultCVS===null || resultCVS===''||resultCVS==':logger:'){
		  		
			    $('#result').val(data);
			    console.log(resultCVS);
			    $("#gif").css("display", "none");
			    $(function() {
			    	
	  				$('#CSVTable').CSVToTable(resultCVS,{
	  					tableClass:'tablesorter'
	  				}).bind("loadComplete",function() { 
	  					$('#CSVTable').find('#cvsT').addClass('tablesorter');
	  					$('#CSVTable').find('table').tablesorter();
					});;
				});

		  	}else{
		  		$("#gif").css("display", "none");
		  		//$('#dialog').dialog('open');
		  		$('#alert').css("display", "block");

		  	}
		  	
		});

	}
	isEmpty = function (value){
		if (value==='') return true;
		if (value===undefined) return true;
		if (value===null) return true;
		return false;
	}
	submit= function(){
		console.log('start submit');
		
		var studyI = $(document).find('#studyI').val();
		var taskI  = $(document).find('#taskI').val();
		var sinceI = $(document).find('#sinceI').val();
		var untilI = $(document).find('#untilI').val();
		var curr = $(document).find('#buttonStudies').html();
		var start = curr.indexOf('">');
		var index = curr.indexOf('<i');
		curr = curr.substr(start+2,index-start-3);
		if(Date.parse(untilI)<Date.parse(sinceI)){ 
			alert('Please enter correct dates');
			return;
		}
		if (untilI=='') {
			var currentdate = new Date(); 
			var datetime =  (currentdate.getMonth()+1)+"/"+currentdate.getDate()+"/"+currentdate.getFullYear();
			untilI= datetime;
			$(document).find('#untilI').val(untilI);
		}
		if (sinceI==''){
			 var currentdate = new Date(); 
			 var datetime =  (currentdate.getMonth())+"/01/"+currentdate.getFullYear();

			 sinceI = datetime;
			 $(document).find('#sinceI').val(sinceI);
		}
		
		if (isEmpty(studyI) && (curr=='History')){
			//$('#dialog2').dialog('open');
			//return;
		}
		if (isEmpty(studyI) && (curr=='Any')){
			//$('#dialog').dialog('open');
			//return;
		}
		if (curr=='History' && $('#taskC').is(":checked") ){
			//alert('History studies are restricted to show by study only');
			//return;
		}
		if ($('#timeC').is(":checked") && (!($('#sinceI').val()) || !($('#untilI').val())) ){

			// $('#dialog3').dialog('open');
			// return;


		}

		if(isEmpty(studyI) && curr=='Any'){

			$('#dialog').dialog('open');

		}else{
			$('#CSVTable').html("");
			$("#gif").css("display", "block");
			$('#alert').css("display", "none");
			var data = getData();
			postForm(data);

		}

	}

});



</script>
</head>


<body>
	
<div class="container">
	<!--<div id="instruct1">
		<font color="DarkGray">Select Demo or Research studies. If you select Research, select &quot;Current&quot; for studies using PI's participant pool right now, &quot;History&quot; for any study that has ever used PI&rsquo;s participant pool, and &quot;Any&quot; for any research study regardless of whether it has ever used PI&rsquo;s participant pool.</font>
		
	</div>!-->
	
	<div>
		<button class="ui-button-primary" id="dbButton" data-dropdown="#dropdown-2" id="buttonDB">Research <i class="icon-caret-down" style="margin-left:10px;"></i></button>
		<button class="ui-button-primary "  id="buttonStudies" data-dropdown="#dropdown-1">Current <i class="icon-caret-down" ></i></button>
		<button id="submit" onclick="submit()" class="ui-button-success" style="margin-left:10px;">Submit</button>
		<button id="collapse" class="ui-button-primary" >Instructions <i class="icon-sort-down"></i></button>
	<div>
	</br></br>
	<div id="instruct1" >
		<font color="DarkGray">Choose whether you want participation data from the demo site, the research site, or both. You can also choose &quot;current&quot; (to get participation data from those studies that are in the pool right now), &quot;history&quot; (to get data from studies that have ever been in the research pool), or &quot;any&quot; (to get data from all research studies, regardless of whether or not they have ever been in the pool).</br></br>
 
		Enter the study id or any part of the study id (the study name that that appears in an .expt file). Note that the study id search feature is case-sensitive. If you leave this box blank you will get data from all studies within your specified time period.</br></br>
 
		You can also enter a task name or part of a task name (e.g., realstart) if you only want participation data from certain tasks. You can also choose how you want the data displayed. If you click &quot;Study&quot;, you will see data from any study that meets your search criteria. If you also check &quot;Task&quot; you will see data from any study that meets your search criteria separated out by task. The &quot;Data Group&quot; option will allow you to see whether a given study is coming from the demo or research site.</br></br> Please note that completion rates are calculated from the first to the last page of the study.</font>
	</div>	
	<!--
	<div id="instruct2">
		<font color="DarkGray">Enter the study id or any part of the study id. You can also enter the task name (or a part of the task name) if you want to see only specific tasks.</font>
	</div> !-->
	
		<div id="enterStudy"  class="inline" style="padding-right:10px;">
			<label>Enter Study </label>
			<input id="studyI" type="text" id="studyName"></input>
		</div>
		<div id="enterStudy"  class="inline" style="padding-right:10px;">
			<label>Enter Task </label>
			<input id="taskI" type="text" id="taskName"></input>
		</div>
		<div id="enterStudy"  class="inline" style="padding-right:10px;">
			<label>Since: </label>
			<input id="sinceI" type="text" ></input><i id="sinceIcon" class="icon-calendar" style="margin-left:5px;"></i> 
		</div>
		<div id="enterStudy"  class="inline" style="padding-right:10px;">
			<label>Until: </label>
			<input id="untilI" type="text" id="until" type="text" ></input><i id="untilIcon"  class="icon-calendar" style="margin-left:5px;"></i>
		</div>
		
		
	
		<div id="view" style="position:relative;left:-40px;">
			<p>
				<div style="display:inline-block;">
					<ul style="list-style-type: none;">
    					<li><label>Show By: </label></li>
    					<li><label>(or combination of those)</label></li>
    					
  					</ul>
  				</div>
  				<div style="display:inline-block;padding:10px;margin-left:20px;">
					<input id="studyC" type="checkbox" name="sports" value="soccer" style="margin-left:10px;"/> Study
					<input id="taskC" type="checkbox" name="sports" value="soccer" style="margin-left:13px;" /> Task
					<input id="dataC" type="checkbox" name="sports" value="soccer" style="margin-left:13px;" /> Data Group
					<input id="timeC" type="checkbox" name="sports" value="soccer" style="margin-left:13px;" /> Time
					<div id="timeTable" style="display:inline-block;border:1px solid;padding:10px;">
						 <input id="dayC" type="checkbox" name="sports" value="soccer"  />D
						 <input id="weekC" type="checkbox" name="sports" value="soccer"  />W
						 <input id="monthC" type="checkbox" name="sports" value="soccer"  />M
						 <input id="yearC" type="checkbox" name="sports" value="soccer"  />Y


					</div>
				</div>
				
				
		</div>
	
	<button id="download" onclick="download()" class="ui-button-success" style="margin-left:10px;">Download CSV</button>
	<hr width="82%" align="left">
	
	<p>
		<div id="alert"class="ui-widget" style="display: none;width:82%;">
		    <div class="ui-state-default ui-corner-all">
		        <p><span class="ui-icon ui-icon-info" style="float: left; margin-right: .3em;"></span>
		             No data match your request.</p>
		    </div>
		</div>
		<img id="gif" src="img/loading.gif"  style="display:none;margin-left:40%;">
		<div id="CSVTable" style="width:82%"></div>
	</p>

</div>	

	


<div id="dropdown-1" class="dropdown dropdown-tip">
    <ul class="dropdown-menu" id="uldrop1">
        <li id="currentLi"><a href="#1">Current</a></li>
        <li id="HistoryLi"><a href="#2">History</a></li>
        <li id="AllLi"><a href="#3">Any</a></li>
    </ul>
</div>
<div id="dropdown-2" class="dropdown dropdown-tip">
    <ul class="dropdown-menu" id="uldrop2">
        <li id="DemoLi"><a href="#1">Demo</a></li>
        <li id="ResearchLi"><a href="#2">Research</a></li>
        <li id="BothLi"><a href="#3">Both</a></li>
    </ul>
</div>
<div id="dialog" title="Long search warning">
        <p><font size=2>This might take a while. Are you sure you do not want to enter any conditions to limit your search?</font></p>

</div>
<div id="dialog2" title="Study Name">
        <p><font size=2>Please provide study name to restrict your search</font></p>

</div>
<div id="dialog3" title="Study Name Missing">
        <p><font size=2>Please Provide Since/Until Date</font></p>
</div>
<div id="cpanel" title="Control Panel">
        <p><font size=2>Study List Provider: </font>
	        <select id="provider">
	  			<option value="path">Path</option>
	  			<option value="url">URL</option>
	  			<option value="back">Backend</option>
			</select>
			&nbsp&nbsp
			<font size=2>Caching: </font>
			<select id="refresh">
	  			<option value="no">No Caching</option>
	  			<option value="1">1</option>
			</select></br></br>
			<font size=2>URL for Current Studies: </font>
			<input id="curl" type="text" value="" style="width:400px;"> </input></br>
			<font size=2>URL for History Studies: </font>
			<input id="hurl" type="text" value="" style="width:400px;"></input></br>
			<font size=2>Path for Current Studies: </font>		
			<input id="cpath" type="text" value="" style="width:400px;"></input></br>
			<font size=2>Path for History Studies: </font>		
			<input id="hpath" type="text" value="" style="width:400px;"></input>

		</p>
		<p>
			<font size=2>Connect to: </font></br>			
			<select  id="connect">
				<option value="test">Test</option>
				<option value="oldwarehouse">Old warehouse</option>
				<option value="newwarehouse">New warehouse</option>

			</select>
		</p>
		<p>
			<font size=2>Use Threads: </font></br>			
			<select  id="threads">
				<option value="yes">Yes</option>
				<option value="no">no</option>
			</select><br/>
			Number of Threads: <input id="threadsNum" type="text" value="3" style="width:200px;"> </input></br>
			BaseURL: <input id="baseURL" type="text" value="" style="width:400px;"> </input></br>


</div>
<script type="text/javascript" src="js/FileSaver.js"></script>
</body>


</html>